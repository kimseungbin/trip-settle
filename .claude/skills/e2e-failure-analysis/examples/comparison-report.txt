Example: Comparison Report (Current vs Previous Run)

=== COMPARISON REPORT ===

Compare test results between consecutive CI runs to identify regressions and improvements.

## Current vs Previous Run 📊

**Current Commit**: abc123de - "feat(frontend): Add delete button"
**Current Run**: 2025-10-26 14:00:00 UTC (1 hour ago)

**Previous Commit**: xyz789fg - "style(frontend): Update colors"
**Previous Run**: 2025-10-26 11:00:00 UTC (4 hours ago)

**Time Between Runs**: 3 hours (2 commits)

---

### Summary

| Metric | Current | Previous | Change | Status |
|--------|---------|----------|--------|--------|
| **Total Tests** | 42 | 42 | No change | - |
| **Passing** | 38 | 40 | -2 | 🔴 Worse |
| **Failing** | 4 | 2 | +2 | 🔴 Worse |
| **Pass Rate** | 90.5% | 95.2% | -4.7% | 📉 Degraded |
| **Duration** | 180s | 175s | +5s | ⏱️ Slower |

**Overall Status**: 🔴 DEGRADED

**Summary**:
- 2 new failures introduced (regressions)
- 1 test fixed (improvement)
- 1 test continues to fail (chronic)
- Pass rate dropped by 4.7%

---

## 🆕 New Failures (2 tests)

Tests that were **passing** ✅ in previous run, now **failing** ❌:

These are **REGRESSIONS** - high priority!

---

### 1. ExpenseTracker › should delete expense [chromium]

**Status Change**: ✅ PASSING → ❌ FAILING

**Current Run**:
- Error Type: Timeout
- Error Message: `Timeout 5000ms exceeded waiting for getByRole('button', { name: 'Delete' })`
- Duration: 5000ms
- Browser: chromium

**Artifacts**:
- 📸 Screenshot: test-results/expense-delete-chromium/test-failed-1.png
- 🎥 Video: test-results/expense-delete-chromium/video.webm
- 🔍 Trace: test-results/expense-delete-chromium/trace.zip

**Previous Run**: Passed (no errors)

**Analysis**:
- Test was stable (passing) in previous run
- Broke in current commit (abc123de)
- Commit message: "feat(frontend): Add delete button"
- **Likely Cause**: The commit that added delete button broke the test!

**Root Cause Investigation**:
```bash
# What changed between runs?
git diff xyz789fg abc123de -- packages/frontend/src/components/ExpenseList.svelte

# Commit that introduced failure
git show abc123de

# Check for delete button changes
git log --oneline -S "Delete" -- packages/frontend/src/components/ExpenseList.svelte
```

**Hypothesis**:
The "Add delete button" feature changed button selectors or DOM structure,
making the test selector unable to find the button.

**Recommended Actions**:
1. **Priority**: 🔴 HIGH (regression, broke working test)
2. **Immediate**: Review commit abc123de for button selector changes
3. **Fix**: Update test selector or fix button implementation
4. **Verify**: Run test locally to reproduce

**Communication**:
```
@team: New failure detected in commit abc123de!

Test: ExpenseTracker › should delete expense [chromium]
Status: ✅ → ❌ (REGRESSION)
Commit: abc123de ("feat(frontend): Add delete button")

The delete button feature broke this test. Please review and fix.
```

---

### 2. CurrencySelector › should switch currencies [webkit]

**Status Change**: ✅ PASSING → ❌ FAILING

**Current Run**:
- Error Type: Assertion
- Error Message: `Expected USD, received EUR`
- Duration: 1250ms
- Browser: webkit

**Artifacts**:
- 📸 Screenshot: test-results/currency-switch-webkit/test-failed-1.png
- 🎥 Video: test-results/currency-switch-webkit/video.webm

**Previous Run**: Passed (no errors)

**Analysis**:
- Test was stable in previous run
- Broke in current commit (abc123de)
- Error indicates state management issue (wrong currency)

**Root Cause Investigation**:
```bash
# Check for currency-related changes
git diff xyz789fg abc123de -- packages/frontend/src/components/CurrencySelector.svelte

# Check state management changes
git diff xyz789fg abc123de -- packages/frontend/src/lib/stores/
```

**Hypothesis**:
Currency state isn't updating correctly, possibly due to:
- State initialization bug
- Prop passing issue
- Event handler regression

**Recommended Actions**:
1. **Priority**: 🔴 HIGH (regression)
2. **Immediate**: Check CurrencySelector component changes in abc123de
3. **Debug**: Add console.log to trace currency state updates
4. **Fix**: Correct state management issue

**Communication**:
```
@team: Currency switching broken in commit abc123de!

Test: CurrencySelector › should switch currencies [webkit]
Status: ✅ → ❌ (REGRESSION)
Error: Expected USD, got EUR

State management issue. Please review currency selector logic.
```

---

## ✅ Fixed Tests (1 test)

Tests that were **failing** ❌ in previous run, now **passing** ✅:

**Celebrate these wins!** 🎉

---

### 1. Onboarding › should complete onboarding flow [chromium]

**Status Change**: ❌ FAILING → ✅ PASSING

**Previous Run**:
- Was failing for 2 commits
- Error: `Expected URL to be '/expense-tracker', received '/onboarding'`
- Error Type: Assertion (navigation)

**Current Run**: Passed ✅

**Analysis**:
- Test was broken for 2 commits
- Fixed in commit abc123de
- Congrat ulations! 🎊

**What Fixed It**:
```bash
# Review changes that fixed the issue
git show abc123de -- packages/frontend/src/components/Onboarding.svelte

# Compare with first failing commit
git diff <first-failing-commit> abc123de -- packages/frontend/src/components/Onboarding.svelte
```

**Hypothesis**:
Navigation logic was corrected in this commit, or the feature that broke it was reverted.

**Learning Opportunity**:
- Document what fixed the issue
- Add regression test to prevent future breaks
- Share knowledge with team

**Communication**:
```
@team: Great news! Onboarding flow fixed! ✅

Test: Onboarding › should complete onboarding flow [chromium]
Status: ❌ → ✅ (FIXED in commit abc123de)
Was failing for: 2 commits

Nice work fixing this!
```

---

## ❌ Still Failing (1 test)

Tests that **continue to fail** (failing in both runs):

These are **CHRONIC ISSUES** - need systematic fix.

---

### 1. ExpenseTracker › should add expense with Enter key [chromium]

**Status Change**: ❌ FAILING → ❌ STILL FAILING

**Current Run**:
- Error Type: Timeout
- Error Message: `Timeout 5000ms exceeded waiting for getByRole('button', { name: 'Add' })`
- Duration: 5000ms

**Previous Run**:
- Same error (timeout waiting for button)
- Failing for 3 days (15 commits)

**Analysis**:
- **Chronic failure**: Failing for 3 days straight
- **High impact**: Blocking merges and CI reliability
- **No improvement**: Still failing after 15 commits
- **Failure rate**: 80% (4 out of last 5 runs)

**History**:
```
Last 10 runs:
❌ Current  (abc123de) - 1h ago
❌ Previous (xyz789fg) - 4h ago
❌ Run -2    (stu901ab) - 1d ago
✅ Run -3    (vwx234ef) - 1d ago
❌ Run -4    (pqr678st) - 1d ago
❌ Run -5    (mno345jk) - 2d ago
✅ Run -6    (jkl012gh) - 2d ago
❌ Run -7    (ghi789cd) - 2d ago
❌ Run -8    (def456ab) - 3d ago  ← First failure
✅ Run -9    (bcd890ef) - 3d ago  ← Last pass
```

**Trend**: DEGRADING (failure rate increasing)

**Recommended Actions**:
1. **Priority**: 🔴 CRITICAL (chronic issue, 3 days old)
2. **Escalate**: This is blocking the team for 3 days
3. **Root Cause**: See Blame Integration and Trend Analysis
4. **Consider**: Temporarily disable test if blocking critical work

---

## 📈 Trend Visualization

**Last 5 Runs** (newest first):
```
Run 1 (current):  4 failures  ████  (90.5% pass)
Run 2 (previous): 2 failures  ██    (95.2% pass)
Run 3:            2 failures  ██    (95.2% pass)
Run 4:            2 failures  ██    (95.2% pass)
Run 5:            2 failures  ██    (95.2% pass)
```

**Observation**: Sudden spike in failures (2 → 4) in current run.

**Trend**: 🔴 DEGRADING (getting worse)

---

## 🎯 Action Items (Prioritized)

### Immediate (Fix Today) 🔴
1. Investigate 2 new regressions in commit abc123de
2. Review "Add delete button" feature for test breakage
3. Fix currency state management issue
4. Consider reverting abc123de if fixes take too long

### Short-term (This Week) 🟡
1. Fix chronic ExpenseTracker failure (blocking for 3 days)
2. Add regression tests for delete and currency features
3. Review test selectors for robustness

### Celebrate 🎉
1. Onboarding flow fixed - document what worked!

---

## 📋 Comparison Commands

```bash
# Get test lists
CURRENT="HEAD"
PREVIOUS="HEAD~1"

# Current failures
git notes --ref=ci/e2e-failures show $CURRENT | \
  grep "^test_name" | cut -d'=' -f2 | sort > current.txt

# Previous failures
git notes --ref=ci/e2e-failures show $PREVIOUS | \
  grep "^test_name" | cut -d'=' -f2 | sort > previous.txt

# New failures (in current, not in previous)
comm -23 current.txt previous.txt

# Fixed tests (in previous, not in current)
comm -13 current.txt previous.txt

# Still failing (in both)
comm -12 current.txt previous.txt

# What changed between runs?
git diff $PREVIOUS $CURRENT -- packages/frontend/src/

# View commits between runs
git log --oneline $PREVIOUS..$CURRENT
```

---

## 🔔 Summary

**Status**: 🔴 DEGRADED (worse than previous run)

**Key Changes**:
- +2 new failures (regressions) - **URGENT**
- +1 fixed test (improvement) - **CELEBRATE**
- 1 chronic failure persists - **ESCALATE**

**Impact**:
- Pass rate: 95.2% → 90.5% (-4.7%)
- Failure count: 2 → 4 (+100%)
- Team velocity: BLOCKED by 1 chronic + 2 new failures

**Next Run Goal**:
- Fix 2 new regressions (get back to 2 failures)
- Address chronic failure (get to 0 failures)
- Target: 100% pass rate

**Detection Metadata**:
- Comparison run: 2025-10-26 15:00:00 UTC
- Commits compared: xyz789fg vs abc123de
- Time range: 3 hours (2 commits)
- Detection method: Git notes diff + set operations
