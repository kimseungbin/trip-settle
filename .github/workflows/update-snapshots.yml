name: Update Visual Snapshots

# This workflow updates visual regression test snapshots in the remote CI environment.
# Visual tests should NEVER be updated locally due to rendering inconsistencies.
#
# Trigger methods:
# 1. Manual: Go to Actions tab â†’ "Update Visual Snapshots" â†’ Run workflow
# 2. PR Comment: Comment "/update-snapshots" on a pull request
# 3. Commit Footer: Add "Snapshots: update" footer to commit message

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to update snapshots on'
        required: false
        default: ''

  # Trigger via PR comment
  issue_comment:
    types: [created]

  # Trigger via commit footer containing "Snapshots: update"
  push:
    branches:
      - '**'

# Prevent simultaneous snapshot update runs on the same branch
# Queue new runs to ensure all updates complete without conflicts
concurrency:
  group: update-snapshots-${{ github.ref }}
  cancel-in-progress: false

# Sets permissions of the GITHUB_TOKEN to allow pushing commits and git notes
permissions:
  contents: write

jobs:
  # Check if workflow should run
  check-trigger:
    name: Check Trigger Condition
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      branch: ${{ steps.check.outputs.branch }}
    steps:
      - name: Checkout code (for scripts)
        uses: actions/checkout@v4

      - name: Check trigger condition
        id: check
        run: ./.github/scripts/snapshots/check-trigger.sh

  # Update snapshots
  update-snapshots:
    name: Update Snapshots in CI
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.branch }}
          # Need write access to push changes
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Record workflow start
        id: record_start
        run: |
          echo "CHECKOUT_SUCCESS=true" >> $GITHUB_ENV
          echo "DOCKER_SUCCESS=false" >> $GITHUB_ENV
          echo "PLAYWRIGHT_SUCCESS=false" >> $GITHUB_ENV
          echo "COMMIT_SUCCESS=false" >> $GITHUB_ENV
          echo "PUSH_SUCCESS=false" >> $GITHUB_ENV
          echo "HAS_CHANGES=false" >> $GITHUB_ENV
          echo "CHANGED_FILES_COUNT=0" >> $GITHUB_ENV
          echo "WORKFLOW_STATUS=running" >> $GITHUB_ENV
          echo "TRIGGER_METHOD=${{ github.event_name }}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Record Docker setup success
        run: echo "DOCKER_SUCCESS=true" >> $GITHUB_ENV

      - name: Cleanup existing Docker resources
        run: ./.github/scripts/docker/cleanup-resources.sh docker-compose.e2e.yml

      - name: Run visual tests with snapshot update
        run: |
          echo "ðŸ“¸ Updating visual snapshots in remote CI environment..."
          echo "â„¹ï¸  Updating all visual snapshots (tests/visual/ and tests/e2e/)"
          PLAYWRIGHT_ARGS="--update-snapshots" docker compose -f docker-compose.e2e.yml up --build --abort-on-container-exit
          echo "PLAYWRIGHT_SUCCESS=true" >> $GITHUB_ENV
        env:
          DOCKER_USER: root
          TEST_ENV: ci-docker
          UPDATING_SNAPSHOTS: true

      - name: Check for snapshot changes
        id: check_changes
        run: |
          if git diff --quiet packages/frontend/tests; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
            echo "CHANGED_FILES_COUNT=0" >> $GITHUB_ENV
            echo "â„¹ï¸ No snapshot changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            CHANGED_COUNT=$(git diff --name-only packages/frontend/tests | wc -l | xargs)
            echo "CHANGED_FILES_COUNT=${CHANGED_COUNT}" >> $GITHUB_ENV
            echo "âœ… Snapshot changes detected (${CHANGED_COUNT} files)"
          fi

      - name: Configure git for bot
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ./.github/actions/configure-git-bot

      - name: Commit and push snapshot updates
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add packages/frontend/tests

          # Create descriptive commit message
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)
          git commit -m "test(frontend): Update visual snapshots in CI [skip ci]

          Updated $CHANGED_FILES snapshot file(s) in remote CI environment.

          This ensures pixel-perfect consistency with the CI/CD pipeline.
          Visual snapshots should only be generated in the remote environment
          to avoid platform-specific rendering differences.

          ðŸ¤– Generated by GitHub Actions
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "COMMIT_SUCCESS=true" >> $GITHUB_ENV

          git push

          echo "PUSH_SUCCESS=true" >> $GITHUB_ENV

      - name: Comment on PR (if triggered by PR comment)
        if: github.event_name == 'issue_comment' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Visual snapshots have been updated in the remote CI environment and committed to this branch.\n\nPlease review the changes before merging.'
            })

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-snapshots
          path: packages/frontend/playwright-report/
          retention-days: 7

      - name: Upload visual test artifacts (failed + passed)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-artifacts
          path: |
            packages/frontend/test-results/**/test-failed-*.png
            packages/frontend/test-results/**/diff-*.png
            packages/frontend/test-results/**/*-actual.png
            packages/frontend/test-results/**/*-expected.png
            packages/frontend/test-results/**/error-context.md
            packages/frontend/tests/**/ui-snapshots.spec.ts-snapshots/*.png
          retention-days: 7

      - name: Capture workflow metadata in git notes
        if: always()  # Run even if previous steps failed
        run: |
          # Set final workflow status
          if [ "${{ job.status }}" = "success" ]; then
            echo "WORKFLOW_STATUS=success" >> $GITHUB_ENV
          else
            echo "WORKFLOW_STATUS=failure" >> $GITHUB_ENV
            echo "ERROR_STEP=${{ job.status }}" >> $GITHUB_ENV
            echo "ERROR_MESSAGE=Workflow failed - check job logs" >> $GITHUB_ENV
          fi

          # Extract metadata
          ./.github/scripts/extract-snapshot-update-metadata.sh snapshot-update-note.txt

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch existing notes (may not exist yet)
          git fetch origin refs/notes/ci/snapshot-updates:refs/notes/ci/snapshot-updates 2>/dev/null || \
            echo "â„¹ï¸ No existing notes found (first run)"

          # Add note to current commit
          if git notes --ref=ci/snapshot-updates add -F snapshot-update-note.txt ${{ github.sha }} 2>/dev/null; then
            echo "âœ… Snapshot update metadata note created"
          else
            # Note already exists, append instead
            echo "â„¹ï¸ Note already exists, updating..."
            git notes --ref=ci/snapshot-updates append -F snapshot-update-note.txt ${{ github.sha }}
          fi

          # Push to remote
          if git push origin refs/notes/ci/snapshot-updates --force 2>&1; then
            echo "âœ… Snapshot update metadata pushed to git notes"
          else
            echo "âŒ ERROR: Failed to push snapshot update metadata notes"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "### âœ… Snapshots Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Visual regression snapshots have been updated in the remote CI environment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:** $(git diff HEAD~1 --name-only packages/frontend/tests | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No visual snapshot updates were needed." >> $GITHUB_STEP_SUMMARY
          fi