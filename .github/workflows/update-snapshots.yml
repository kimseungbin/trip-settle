name: Update Visual Snapshots

# This workflow updates visual regression test snapshots in the remote CI environment.
# Visual tests should NEVER be updated locally due to rendering inconsistencies.
#
# Trigger methods:
# 1. Manual: Go to Actions tab â†’ "Update Visual Snapshots" â†’ Run workflow
# 2. PR Comment: Comment "/update-snapshots" on a pull request
# 3. Commit Message: Include "[update-snapshots]" in commit message

on:
  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to update snapshots on'
        required: false
        default: ''

  # Trigger via PR comment
  issue_comment:
    types: [created]

  # Trigger via commit message containing [update-snapshots]
  push:
    branches:
      - '**'

# Sets permissions of the GITHUB_TOKEN to allow pushing commits
permissions:
  contents: write

jobs:
  # Check if workflow should run
  check-trigger:
    name: Check Trigger Condition
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      branch: ${{ steps.check.outputs.branch }}
    steps:
      - name: Check trigger condition
        id: check
        run: |
          SHOULD_RUN="false"
          BRANCH="${{ github.ref_name }}"

          # Manual workflow_dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SHOULD_RUN="true"
            if [ -n "${{ github.event.inputs.branch }}" ]; then
              BRANCH="${{ github.event.inputs.branch }}"
            fi
          fi

          # PR comment "/update-snapshots"
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            COMMENT="${{ github.event.comment.body }}"
            if [[ "$COMMENT" == "/update-snapshots"* ]] && [ "${{ github.event.issue.pull_request }}" != "" ]; then
              SHOULD_RUN="true"
              # Get PR branch (requires additional API call, simplified here)
              echo "PR comment trigger detected"
            fi
          fi

          # Push with [update-snapshots] in commit message
          if [ "${{ github.event_name }}" = "push" ]; then
            # Use heredoc to safely handle multi-line commit messages
            COMMIT_MSG=$(cat <<'EOF'
          ${{ github.event.head_commit.message }}
          EOF
          )
            if [[ "$COMMIT_MSG" == *"[update-snapshots]"* ]]; then
              SHOULD_RUN="true"
            fi
          fi

          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

  # Update snapshots
  update-snapshots:
    name: Update Snapshots in CI
    runs-on: ubuntu-latest
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.branch }}
          # Need write access to push changes
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cleanup existing Docker resources
        run: |
          echo "ðŸ§¹ Cleaning up Docker resources..."
          # Stop and remove containers (anonymous volumes auto-cleaned with -v)
          docker compose -f docker-compose.e2e.yml down -v --remove-orphans 2>/dev/null || true

          # Remove any dangling images to free up space
          docker image prune -f || true

      - name: Run E2E tests with snapshot update
        run: |
          echo "ðŸ“¸ Updating visual snapshots in remote CI environment..."
          PLAYWRIGHT_ARGS="--update-snapshots" docker compose -f docker-compose.e2e.yml up --build --abort-on-container-exit
        env:
          DOCKER_USER: root
          TEST_ENV: ci-docker
          UPDATING_SNAPSHOTS: true

      - name: Check for snapshot changes
        id: check_changes
        run: |
          if git diff --quiet packages/frontend/tests; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No snapshot changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Snapshot changes detected"
          fi

      - name: Commit and push snapshot updates
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add packages/frontend/tests

          # Create descriptive commit message
          CHANGED_FILES=$(git diff --cached --name-only | wc -l)
          git commit -m "test(frontend): Update visual snapshots in CI [skip ci]

          Updated $CHANGED_FILES snapshot file(s) in remote CI environment.

          This ensures pixel-perfect consistency with the CI/CD pipeline.
          Visual snapshots should only be generated in the remote environment
          to avoid platform-specific rendering differences.

          ðŸ¤– Generated by GitHub Actions
          Workflow: ${{ github.workflow }}
          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git push

      - name: Comment on PR (if triggered by PR comment)
        if: github.event_name == 'issue_comment' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Visual snapshots have been updated in the remote CI environment and committed to this branch.\n\nPlease review the changes before merging.'
            })

      - name: Upload snapshot diff report
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-diff-report
          path: |
            packages/frontend/playwright-report/
            packages/frontend/test-results/
          retention-days: 7

      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "### âœ… Snapshots Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Visual regression snapshots have been updated in the remote CI environment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:** $(git diff HEAD~1 --name-only packages/frontend/tests | wc -l)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Changes" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No visual snapshot updates were needed." >> $GITHUB_STEP_SUMMARY
          fi