#!/bin/sh

# Commit-msg hook for trip-settle
# This hook validates commit messages before accepting the commit
#
# Checks performed:
# 1. Visual snapshot handling for UI changes
#
# This hook receives the commit message file path as $1

set -e  # Exit immediately if any command fails

# Get the commit message file path (passed as first argument)
commit_msg_file="$1"

# Check for UI changes that may require visual snapshot updates
changed_files=$(git diff --cached --name-only --diff-filter=ACM)

if echo "$changed_files" | grep -qE "\.(svelte|css)$"; then
    echo ""
    echo "=========================================="
    echo "‚ö†Ô∏è  UI Changes Detected"
    echo "=========================================="
    echo ""
    echo "You've modified UI files that may affect visual snapshots:"
    echo ""
    echo "$changed_files" | grep -E "\.(svelte|css)$" | sed 's/^/  üìÑ /'
    echo ""

    # Read the commit message
    commit_msg=$(cat "$commit_msg_file")

    # Check for snapshot handling footers (or legacy keywords for backward compatibility)
    has_update_keyword=false
    has_skip_keyword=false

    if echo "$commit_msg" | grep -qE "(Snapshots: update|\[update-snapshots\])"; then
        has_update_keyword=true
    fi

    if echo "$commit_msg" | grep -qE "(Snapshots: skip|\[skip-snapshots\])"; then
        has_skip_keyword=true
    fi

    if [ "$has_update_keyword" = true ]; then
        echo "‚úÖ Snapshot update footer detected: Snapshots: update"
        echo "   CI will automatically update visual snapshots after push."
        echo ""
        echo "=========================================="
    elif [ "$has_skip_keyword" = true ]; then
        echo "‚úÖ Snapshot skip footer detected: Snapshots: skip"
        echo "   You've confirmed these changes don't affect visual appearance."
        echo ""
        echo "=========================================="
    else
        echo "‚ùå ERROR: Missing snapshot handling footer"
        echo "=========================================="
        echo ""
        echo "UI files were modified but no snapshot footer found in commit message."
        echo ""
        echo "You must explicitly declare snapshot handling intent:"
        echo ""
        echo "  Option 1: Snapshots: update"
        echo "    ‚Ä¢ Use when UI appearance changes (styling, layout, new elements)"
        echo "    ‚Ä¢ CI will automatically update snapshots after push"
        echo "    ‚Ä¢ Example:"
        echo "      git commit -m \"feat: Redesign button"
        echo ""
        echo "      Changes button color and adds hover effect."
        echo ""
        echo "      Snapshots: update\""
        echo ""
        echo "  Option 2: Snapshots: skip"
        echo "    ‚Ä¢ Use when UI files changed but appearance unchanged"
        echo "    ‚Ä¢ Example: Internal refactoring, prop renaming, type changes"
        echo "    ‚Ä¢ Example:"
        echo "      git commit -m \"refactor: Extract component logic"
        echo ""
        echo "      Moves validation logic to separate function."
        echo ""
        echo "      Snapshots: skip\""
        echo ""
        echo "See CLAUDE.md 'Playwright E2E Testing ‚Üí Visual Snapshot Management' for details."
        echo ""
        echo "=========================================="
        echo "üí° Tip: Use --no-verify to bypass (not recommended)"
        echo "=========================================="
        echo ""
        exit 1
    fi
fi

exit 0
