#!/bin/sh

# Pre-commit hook for trip-settle
# This hook runs quality checks before allowing a commit
#
# Checks performed:
# 1. Code formatting (Prettier)
# 2. Linting (ESLint)
# 3. Build validation (all packages)
#
# Note: E2E tests are NOT run in pre-commit due to slow execution time.
#       Run manually before pushing: npm run test:e2e:docker

set -e  # Exit immediately if any command fails

echo "=========================================="
echo "🎣 Git Hook: Pre-commit"
echo "=========================================="
echo ""

# Function to print step header
print_step() {
    echo "▶ $1"
    echo "------------------------------------------"
}

# Function to print success
print_success() {
    echo "✅ $1"
    echo ""
}

# Function to print error and exit
print_error() {
    echo ""
    echo "❌ $1"
    echo "=========================================="
    echo "💡 Tip: Fix the issues above and try again"
    echo "   Or use --no-verify to skip hooks (not recommended)"
    echo "=========================================="
    exit 1
}

# 1. Clean any existing build artifacts first
print_step "Cleaning existing build artifacts..."
find packages/infra -type f \( -name "*.js" -o -name "*.d.ts" -o -name "*.js.map" \) ! -name "jest.config.js" ! -name ".eslintrc.js" -delete 2>/dev/null || true
print_success "Cleaned existing artifacts"

# 2. Check code formatting
print_step "Checking code formatting..."
if npm run format:check; then
    print_success "Code formatting check passed"
else
    print_error "Code formatting check failed. Run 'npm run format' to fix."
fi

# 3. Run linters
print_step "Running linters..."
if npm run lint; then
    print_success "Linting passed"
else
    print_error "Linting failed. Fix the issues above."
fi

# 4. Build all packages
print_step "Building all packages..."
if npm run build; then
    print_success "Build successful"
else
    print_error "Build failed. Fix compilation errors above."
fi

# 5. Clean build artifacts after validation
print_step "Cleaning build artifacts..."
find packages/infra -type f \( -name "*.js" -o -name "*.d.ts" -o -name "*.js.map" \) ! -name "jest.config.js" ! -name ".eslintrc.js" -delete 2>/dev/null || true
print_success "Build artifacts cleaned"

# All checks passed!
echo "=========================================="
echo "✅ All pre-commit checks passed!"
echo "=========================================="
echo "💡 Remember to run E2E tests before pushing:"
echo "   npm run test:e2e:docker"
echo "=========================================="
echo ""

exit 0